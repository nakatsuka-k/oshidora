# コイン購入 画面設計書（コインパック選択＋Stripe）

---

## 画面名

* 画面ID: AXCMS-COIN-001
* 画面名: コイン購入
* 目的:
  ユーザーがコインパックを選択し、Stripe決済でコインを購入できるようにする。購入後は所持コインを加算し、元の画面へ戻れる導線を提供する。
* 遷移元:

  * 動画購入（AXCMS-P-001）「コインを購入する」
  * マイページ（コイン購入リンク）
* 遷移先:

  * Stripe Checkout（外部遷移/アプリ内WebView）
  * 決済完了後：コイン付与完了（APP-COIN-GRANT-COMPLETE-001）へ遷移、または遷移元へ戻る
  * キャンセル：遷移元へ戻る
  * 決済失敗：遷移元へ戻る（直前に表示していた画面）

---

## 画面概要

* 本画面はコイン購入の入口画面。
* コインパック（例：100 / 300 / 500 など）を選択し、Stripe決済を開始する。
* 決済後はWebhookでサーバー側が残高を反映し、アプリは残高を再取得して表示更新する。

---

## 画面キャプチャ / ワイヤー

![wireframe](../画面設計書/images/AXCMS-COIN-001.png)

---

## 操作概要

* コインパックを選択する
* 「購入する」タップでStripe Checkoutへ進む
* キャンセルで元の画面へ戻る
* 決済完了後、完了画面または遷移元に戻る（どちらか統一）
* 決済失敗時は、直前に表示していた画面へ戻る（コイン残高は加算されない）

---

## 画面遷移（入口別）

### A. 動画購入から来た場合

* 遷移元: AXCMS-P-001
* 決済完了後:

  * 基本は コイン付与完了（APP-COIN-GRANT-COMPLETE-001）を表示 → 「購入画面へ戻る」
  * もしくは直接 AXCMS-P-001 に戻し、残高再取得 → 購入可能状態へ

* 決済失敗時:

  * AXCMS-P-001 へ戻る（直前画面へ戻る）

### B. マイページのコイン購入リンクから来た場合

* 遷移元: マイページ配下（例：AXCMS-M-xxx）
* 決済完了後:

  * コイン付与完了（APP-COIN-GRANT-COMPLETE-001）を表示 → 「マイページへ戻る」
  * または直接マイページへ戻る

* 決済失敗時:

  * マイページへ戻る（直前画面へ戻る）

---

## 詳細テーブル

| 部品名称      | 部品の種類     | 型      | 桁数  | IN | OUT | 初期値                 | 表示仕様        | エラーNo       | DB情報備考    | テーブル名      | カラム名         |
| :-------- | :-------- | :----- | :-- | :- | :-- | :------------------ | :---------- | :---------- | :-------- | :--------- | :----------- |
| 画面タイトル    | ラベル       | 文字列    | 20  |    | ○   | `コイン購入`             | 上部に表示       |             | 固定文言      |            |              |
| 所持コイン表示   | ラベル       | 数値     | -   |    | ○   | 0                   | 「所持コイン：◯◯」  | COIN-001-01 | ユーザー別     | users      | coin_balance |
| 説明テキスト    | テキスト      | 文字列    | 120 |    | ○   | `コインを購入して動画を視聴できます` | 画面上部        |             | 固定文言      |            |              |
| コインパック一覧  | リスト/カード群  | オブジェクト | -   |    | ○   | -                   | 縦並びカード表示    |             | マスタ表示     | coin_packs | pack_id      |
| コインパックカード | カード       | オブジェクト | -   | ○  |     | 未選択                 | 選択中は枠強調     |             | 選択式       |            |              |
| パック名      | テキスト      | 文字列    | 30  |    | ○   | -                   | 例：`100コイン`  |             | 表示用       | coin_packs | coin_amount  |
| 価格表示      | テキスト      | 数値     | -   |    | ○   | -                   | 例：`¥500`    |             | 表示用       | coin_packs | price_jpy    |
| お得表示      | バッジ       | 文字列    | 20  |    | ○   | 非表示                 | 例：`10%お得`   |             | 任意        | coin_packs | bonus_rate   |
| 注意文言      | テキスト      | 文字列    | 200 |    | ○   | -                   | 返金不可等       |             | 固定 or マスタ |            |              |
| 購入するボタン   | ボタン       | -      | -   | ○  |     | 非活性                 | パック選択で活性    |             | Stripe開始  |            |              |
| キャンセル     | ボタン       | -      | -   | ○  |     |                     | 遷移元へ戻る      |             | 遷移のみ      |            |              |
| ローディング    | モーダル/スピナー | -      | -   |    | ○   | 非表示                 | Checkout開始中 |             | 二重送信防止    |            |              |
| エラーバナー    | バナー       | 文字列    | 200 |    | ○   | 非表示                 | 上部に表示       | COIN-001-XX | 表示のみ      |            |              |

---

## 挙動仕様

### 初期表示

* 画面表示時に取得する

  * 所持コイン（現在残高）
  * コインパック一覧（購入可能パック）

* 表示順

  * 価格の安い順、またはおすすめパックを先頭固定（管理側で制御可能）

---

### パック選択

* コインパックカードをタップすると選択状態になる
* 選択状態になると「購入する」ボタンが活性化される
* 別パックを選択すると選択が切り替わる（複数選択不可）

---

### Stripe Checkout開始

* 「購入する」タップ

  1. ローディング表示
  2. Checkoutセッション作成APIを実行
  3. 返却された Checkout URL へ遷移（外部ブラウザ/アプリ内WebView）
  4. ローディング解除

* 失敗時

  * ローディング解除
  * エラーバナー表示（再試行可能）

---

### 決済完了後の反映

* Stripe決済完了 → Webhook でサーバーが残高加算

* アプリ復帰時（完了URLで戻る or アプリ再表示）に

  * 残高再取得 `GET /api/users/me/balance`
  * 加算が確認できたら完了画面へ遷移、または遷移元へ戻る

* 反映待ちの場合（Webhook遅延など）

  * 「反映を確認中です」表示
  * 一定間隔の再取得（手動の「更新」ボタンでも可）

* 決済失敗の場合（Stripe側で支払い失敗・期限切れ等）

  * 本画面ではエラーを保持せず、直前に表示していた画面（遷移元）へ戻す
  * 遷移元側で必要に応じてトースト/バナー表示（例：`決済に失敗しました`）

---

### キャンセル

* 「キャンセル」で遷移元へ戻る
* 状態変更は行わない

---

## エラー定義（画面側）

| エラーNo       | 発生条件              | 表示文言例           | 復帰    |
| :---------- | :---------------- | :-------------- | :---- |
| COIN-001-01 | 残高取得失敗            | 所持コインの取得に失敗しました | 再読み込み |
| COIN-001-02 | パック一覧取得失敗         | パック情報の取得に失敗しました | 再読み込み |
| COIN-001-03 | Checkoutセッション作成失敗 | 決済の開始に失敗しました    | 再試行   |
| COIN-001-04 | 決済完了後の反映待ち        | コイン反映を確認中です     | 再取得   |
| COIN-001-05 | Stripe決済失敗             | 決済に失敗しました        | 遷移元へ戻る |

---

## API/データ仕様（画面連携レベル）

### 取得系

* 所持コイン

  * `GET /api/users/me/balance`

* コインパック一覧

  * `GET /api/coin-packs`

### Checkout開始

* `POST /api/stripe/checkout/coin-pack`

  * body: `{ packId, returnTo }`
  * returnTo: 決済完了後に戻すアプリ側遷移元識別（`purchase` / `mypage` 等）

### Webhook（サーバー側）

* `POST /webhooks/stripe`

  * 決済成功時にコイン残高を加算
  * 取引履歴（coin_transactions）を作成

---

## 備考

* コイン購入は返金不可などの注意文言を常に表示する（文言は利用規約に合わせる）
* コイン残高と取引履歴はサーバー側を正とし、クライアント側で加算計算しない
* 将来的に以下拡張を想定

  * 初回購入ボーナス
  * キャンペーンパック
  * サブスク型（毎月コイン付与）
