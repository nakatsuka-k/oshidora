# 基本システム仕様書（React Native / Cloudflare 版）

> ショートドラマ動画配信アプリ
> 作成日：2025/12/07
> 作成者：中塚 季利人
> 対象：iOS / Android（React Native）

---

## 1. はじめに

本書は、**ショートドラマ動画配信アプリ（iOS / Android）** の基本システム仕様を記述する。
本システムは **React Native によるネイティブアプリ開発** と、
**Cloudflare を基盤としたサーバーレス構成** を採用し、
高い拡張性・運用性・コスト効率を実現する。

---

## 2. 開発の目的

* 新規俳優・制作スタッフの活躍を支援する「推し活プラットフォーム」の構築
* ショートドラマを中心とした動画コンテンツ配信
* 視聴・評価・コメント・課金（コイン）を統合したモバイルアプリの提供

---

## 3. システムの用途

* React Native アプリによる動画視聴
* 作品・キャストの評価、コメント投稿
* コイン購入および動画閲覧
* キャスト・スタッフによる人気指標の可視化
* 管理者による作品管理、承認、運用

---

## 4. 対象ユーザ

* 一般視聴者
* キャスト・スタッフ（出演者・制作関係者）
* 配信管理者（運営）

---

## 5. 採用技術（Backlog準拠）

### 5-1. フロントエンド

* React Native
* TypeScript
* iOS / Android ネイティブビルド
* 動画再生：Cloudflare Stream Player（SDK / iframe 利用）

---

### 5-2. バックエンド / インフラ

* Cloudflare Workers（API）
* GraphQL（Apollo Server）
* Cloudflare D1（データベース）
* Cloudflare R2（画像・サムネイル）
* Cloudflare Stream（動画配信）
* Cloudflare KV（2FA・一時トークン）
* Cloudflare Turnstile（Bot対策）
* デプロイ：Wrangler + GitHub Actions

---

### 5-3. 外部サービス（Backlog記載）

* **Twilio**

  * SMS 認証（2段階認証）

* **SendGrid**

  * メール送信（登録・認証）

* **Stripe**

  * コイン購入・課金処理

* **PayPay**

  * ポイント連携・換金用途（要事前確認）

* **Apple Developer Program**

  * App Store 提出・配信

* **Firebase**

  * Google Analytics（GAタグ）計測専用
  * ※ 認証・DB・ホスティング用途では使用しない

---

## 6. システム設計方針

### 6-1. 全体アーキテクチャ

```
React Native App（iOS / Android）
        ↓
GraphQL API（Cloudflare Workers）
        ↓
---------------------------------
| Cloudflare D1（DB）           |
| Cloudflare R2（画像）         |
| Cloudflare Stream（動画）     |
| Cloudflare KV（2FA）          |
---------------------------------
        ↓
外部連携
- Twilio（SMS）
- SendGrid（Email）
- Stripe（決済）
- PayPay（ポイント）
```

---

### 6-2. データベース構成（Cloudflare D1）

* users（ユーザ）
* profiles（プロフィール）
* works（作品）
* episodes（エピソード）
* reviews（評価）
* comments（コメント）
* user_wallet（コイン残高）
* coin_transactions（取引履歴）
* view_histories（視聴履歴）
* rankings（ランキング）

---

### 6-3. 認証方式（重要）

#### ① メール認証

* 新規登録時に 6 桁コード送信
* SendGrid 経由でメール送信
* Workers 側で検証処理

#### ② SMS 認証（2段階認証）

* Twilio による SMS 認証
* 有効期限付きトークンを KV / D1 に保存

#### ③ トークン管理

* JWT（署名付き）
* Secure Storage（React Native 側）
* API リクエスト時に Bearer Token 利用

#### ④ ロール管理

* viewer
* performer
* admin
  → GraphQL Resolver で制御

---

## 7. GraphQL 設計概要

### Query

* works
* work(id)
* episodes(workId)
* reviews(workId)
* search(keyword)
* ranking(type)
* me

### Mutation

* createUser
* verifyEmail
* login
* enable2FA
* verifySMS
* purchaseCoin
* spendCoin
* submitReview
* submitComment
* adminApproveComment
* registerWork
* registerEpisode

---

## 8. セキュリティ設計

* API レート制限（Cloudflare Rules）
* Bot 対策（Turnstile）
* 決済処理は全て Workers 側
* クレジットカード情報は保持しない
* 画面録画防止（アプリ側で対応）

---

## 9. Firebase 利用方針（限定）

Firebase は **以下の用途のみに限定して使用する**。

* Google Analytics（GA4）
* イベント計測
* コンバージョン分析

※ 認証、DB、Push通知、Hosting 等には使用しない

---

## 10. 機能一覧

### 基本機能

* 会員登録 / ログイン
* SMS 2段階認証
* チュートリアル（初回）
* 検索
* おすすめ / ピックアップ
* ランキング
* コイン購入 / 消費
* MYページ
* プロフィール編集
* コメント / 評価（承認制）

### 管理機能

* ユーザ管理
* コメント承認
* 作品・エピソード登録
* コイン管理

---

## 11. 目標性能

* MAU：10,000
* API 応答：200ms 以内
* 動画再生遅延：2 秒以内
* 同時接続：5,000 想定

---

## 12. 制限事項

* Cloudflare D1 の大規模運用制限
* Workers の CPU 実行時間制限
* 大量処理は Queue / Durable Objects 検討

---

## 13. 開発・運用

* 開発：React Native + TypeScript
* CI/CD：GitHub Actions
* デプロイ：Cloudflare Workers
* モニタリング：Cloudflare Logs + GA

---

## 14. 今後の拡張想定

* Push通知
* 検索エンジン強化
* レコメンドロジック改善
* 管理画面の高度化

