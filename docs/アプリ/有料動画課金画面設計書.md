# 動画購入 画面設計書（コイン購入／Stripe連携）

---

## 画面名

* 画面ID: AXCMS-P-001
* 画面名: 動画購入
* 目的:
  有料コンテンツ（ショート／映画など）をコインで購入し、購入後は永続的に視聴可能な状態にする。
* 遷移元:

  * 動画詳細（AXCMS-V-002）
* 遷移先:

  * 購入成功：動画詳細（購入済み状態で視聴可能）
  * コイン購入：コイン購入画面（Stripe）
  * キャンセル：動画詳細（AXCMS-V-002）

---

## 画面概要

* 本画面は動画（作品単位など）をコインで購入するための確認・実行画面。
* **話数（エピソード）ごとの購入** については、購入画面を挟む煩わしさを避けるため、**動画詳細画面内のダイアログで購入確認** を行う（本画面を経由しない）。
* 課金ルール想定

  * ショート：6話あたりから少量課金（例：1話50円相当）
  * 映画など：1話100〜500円相当
  * 購入後は永続的に視聴可能
* コインが不足している場合は、Stripe決済によるコイン購入へ誘導する。

---

## 画面キャプチャ / ワイヤー

![wireframe](../画面設計書/images/AXCMS-P-001.png)

---

## 操作概要

* 購入対象（作品／話数）・必要コイン・所持コインを確認
* 所持コインが足りていれば「購入する」で即購入
* 不足時は「コインを購入する」からStripe決済へ進む
* 購入完了後は動画詳細に戻り、視聴可能状態になる

---

## 課金対象の表示単位

購入単位は 2 パターンを想定し、同一画面で表現する。

1. 作品単位（映画など）

* 購入対象名 = 作品名
* 購入対象ID = content_id（例）

2. 話数単位（ショートなど）

* 購入対象名 = 作品名 + 第◯話
* 購入対象ID = episode_id（例）
* 購入確認UI = 動画詳細内ダイアログ（購入画面は挟まない）

---

## 詳細テーブル

| 部品名称        | 部品の種類     | 型   | 桁数  | IN | OUT | 初期値              | 表示仕様            | エラーNo    | DB情報備考    | テーブル名           | カラム名          |
| :---------- | :-------- | :-- | :-- | :- | :-- | :--------------- | :-------------- | :------- | :-------- | :-------------- | :------------ |
| 画面タイトル      | ラベル       | 文字列 | 20  |    | ○   | `購入確認`           | 上部に表示           |          | 固定文言      |                 |               |
| 購入対象サムネイル   | 画像        | URL | -   |    | ○   | -                | 16:9比率          |          | 表示用       | videos/episodes | thumbnail_url |
| 購入対象名       | テキスト      | 文字列 | 150 |    | ○   | -                | 作品名 or 作品名+話数   |          | 表示用       | videos/episodes | title         |
| 課金区分表示      | バッジ       | 文字列 | 10  |    | ○   | -                | `ショート` / `映画` 等 |          | 表示用       | contents        | content_type  |
| 価格（必要コイン）   | ラベル       | 数値  | -   |    | ○   | -                | 「必要コイン：◯◯」      | P-001-01 | 表示用       | pricing         | price_coin    |
| 所持コイン       | ラベル       | 数値  | -   |    | ○   | 0                | 「所持コイン：◯◯」      |          | ユーザー別     | users           | coin_balance  |
| 不足コイン       | ラベル       | 数値  | -   |    | ○   | 非表示              | 不足時のみ表示（差分）     | P-001-02 | 表示のみ      |                 |               |
| 購入後の扱い説明    | テキスト      | 文字列 | 120 |    | ○   | `購入後は永続的に視聴できます` | 価格の下に表示         |          | 固定文言      |                 |               |
| 購入するボタン     | ボタン       | -   | -   | ○  |     | 非活性              | コイン足りている場合のみ活性  |          | 購入実行      |                 |               |
| コインを購入するボタン | ボタン       | -   | -   | ○  |     | 非表示              | 不足時のみ表示         |          | Stripeへ遷移 |                 |               |
| キャンセル       | ボタン       | -   | -   | ○  |     |                  | 前画面へ戻る          |          | 遷移のみ      |                 |               |
| ローディング      | モーダル/スピナー | -   | -   |    | ○   | 非表示              | 購入処理中表示         |          | 二重送信防止    |                 |               |
| エラーバナー      | バナー       | 文字列 | 200 |    | ○   | 非表示              | 上部に表示           | P-001-XX | 表示のみ      |                 |               |

---

## 挙動仕様

### 1. 初期表示

* 画面表示時に取得する情報

  * 購入対象情報（作品／話数、サムネイル、名称）
  * 価格（必要コイン）
  * ユーザー所持コイン
  * 購入済み状態（ユーザー×購入対象）

* 購入済みの場合

  * 本画面は表示せず、動画詳細へ遷移（視聴可能状態で表示）

---

### 2. 表示制御（所持コインによる）

* 所持コイン ≥ 必要コイン

  * 「購入する」ボタン：表示・活性
  * 「コインを購入する」ボタン：非表示
  * 不足コイン表示：非表示

* 所持コイン ＜ 必要コイン

  * 「購入する」ボタン：非活性（押下不可）
  * 「コインを購入する」ボタン：表示
  * 不足コイン表示：表示（不足 = 必要コイン - 所持コイン）

---

### 3. 購入処理（コイン消費）

* 「購入する」タップ時の処理

  1. ローディング表示
  2. 二重送信防止（ボタン無効化）
  3. 購入API実行（サーバー側で原子的に確定）

     * 残高チェック
     * コイン減算
     * 購入レコード作成
     * 視聴権限（永続）付与
  4. 成功したら動画詳細へ遷移（購入済み状態で再表示）

* 失敗時の扱い

  * ローディング解除
  * エラーバナー表示
  * 入力はないので状態復帰のみ（再試行可能）

---

### 4. コイン購入（Stripe）

* 「コインを購入する」タップ時

  * コイン購入画面へ遷移（Stripe Checkout）

* Stripe決済完了後

  * Webhook でサーバーがコイン残高を加算
  * アプリは復帰時に残高を再取得し、画面を再判定
  * 残高が足りれば「購入する」が活性化される

* Stripe決済失敗時

  * 直前に表示していた画面（本画面）へ戻る
  * 残高は加算されないため、不足表示のまま（再試行導線は維持）

---

### 5. キャンセル

* 「キャンセル」タップで動画詳細へ戻る
* 状態変更は行わない（コイン残高・購入状態は不変）

---

## エラー定義（画面側）

| エラーNo    | 発生条件                | 表示文言例           | 復帰           |
| :------- | :------------------ | :-------------- | :----------- |
| P-001-01 | 価格情報が取得できない         | 価格情報の取得に失敗しました  | 再読み込み        |
| P-001-02 | コイン残高が取得できない        | 所持コインの取得に失敗しました | 再読み込み        |
| P-001-03 | 購入APIで残高不足（直前に減った等） | コインが不足しています     | 残高再取得＋購入導線表示 |
| P-001-04 | 購入API失敗（通信）         | 購入処理に失敗しました     | 再試行          |
| P-001-05 | Stripe決済完了後に反映待ち    | コイン反映を確認中です     | 残高再取得        |

---

## API/データ仕様（画面連携レベル）

### 取得系

* 購入対象取得

  * 作品単位: `GET /api/contents/{contentId}`
  * 話数単位: `GET /api/episodes/{episodeId}`

* 価格取得（必要コイン）

  * `GET /api/pricing?targetType=content|episode&targetId=...`

* ユーザー残高取得

  * `GET /api/users/me/balance`

* 購入済み判定

  * `GET /api/purchases/exists?targetType=...&targetId=...`

### 購入実行（コイン消費）

* `POST /api/purchases`

  * body: `{ targetType, targetId }`
  * サーバー側で残高チェック〜減算〜購入確定を一括処理

### コイン購入（Stripe）

* Checkout セッション作成

  * `POST /api/stripe/checkout/coin-pack`
  * body: `{ packId }`
* 決済完了Webhook

  * `POST /webhooks/stripe`（サーバー側のみ）
* 決済完了後は `GET /api/users/me/balance` を再取得して反映

---

## 備考

* 「購入後は永続的に視聴可能」は購入レコードにより判定する
* コイン残高の増減はクライアントで計算せず、常にサーバーの結果を正として扱う
* ショートの「6話から課金」の判定は、動画詳細側で

  * 話数が無料範囲か
  * 課金対象か
    を見て購入画面への遷移制御を行う
* 将来的な拡張

  * セット購入（複数話まとめ）
  * 割引（期間限定）
  * 購入済みの復元（アカウント切替時）

