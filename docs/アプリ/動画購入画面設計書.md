# 動画購入 画面設計書

---

## 画面名

* 画面ID: AXCMS-P-001
* 画面名: 動画購入
* 目的:
  有料動画を購入するための確認および決済を行い、購入完了後に視聴可能な状態にする。
* 遷移元:

  * 動画詳細（AXCMS-V-002）
* 遷移先:

  * 購入完了後：動画詳細（視聴可能状態）
  * キャンセル時：動画詳細（AXCMS-V-002）

---

## 画面概要

* 本画面は有料動画の購入専用画面である。
* 動画情報・価格・所持コイン数を表示し、コイン消費による購入を行う。
* コインが不足している場合は、Stripe 決済によるコイン購入へ誘導する。

---

## 画面キャプチャ / ワイヤー

![wireframe](../画面設計書/images/AXCMS-P-001.png)

---

## 操作概要

* 動画情報を確認した上で「購入する」をタップする
* 所持コインが足りている場合、そのまま購入が完了する
* コイン不足の場合は、Stripe 決済画面へ遷移しコインを購入する
* 購入を行わず戻ることも可能

---

## 詳細テーブル

| 部品名称       | 部品の種類 | 型   | 桁数  | IN | OUT | 初期値    | 表示仕様           | エラーNo    | DB情報備考   | テーブル名  | カラム名          |
| :--------- | :---- | :-- | :-- | :- | :-- | :----- | :------------- | :------- | :------- | :----- | :------------ |
| 画面タイトル     | ラベル   | 文字列 | 20  |    | ○   | `動画購入` | 画面上部に表示        |          | 固定文言     |        |               |
| 動画サムネイル    | 画像    | URL | -   |    | ○   | -      | 16:9 比率        |          | 表示用      | videos | thumbnail_url |
| 動画タイトル     | テキスト  | 文字列 | 120 |    | ○   | -      | サムネイル下に表示      |          | 表示用      | videos | title         |
| 動画価格       | ラベル   | 数値  | -   |    | ○   | -      | 「◯◯コイン」表記      |          | 動画ごと設定   | videos | price_coin    |
| 所持コイン数     | ラベル   | 数値  | -   |    | ○   | 0      | 「所持コイン：◯◯」     |          | ユーザー別    | users  | coin_balance  |
| コイン不足メッセージ | テキスト  | 文字列 | 100 |    | ○   | 非表示    | コイン不足時のみ表示     | P-001-01 | 表示制御     |        |               |
| コイン購入ボタン   | ボタン   | -   | -   | ○  |     | 非表示    | Stripe 決済遷移    |          | コイン不足時表示 |        |               |
| 購入ボタン      | ボタン   | -   | -   | ○  |     | 非活性    | コイン足りている場合のみ活性 |          | 購入確定     |        |               |
| キャンセルボタン   | ボタン   | -   | -   | ○  |     |        | 動画詳細へ戻る        |          | 遷移のみ     |        |               |

---

## 挙動仕様

* 画面表示時に以下の情報を取得する

  * 動画情報（タイトル・価格）
  * ログインユーザーの所持コイン数
  * 対象動画の購入済み状態

* 表示制御

  * すでに購入済みの場合は本画面を表示せず、動画詳細へ遷移する
  * 所持コインが価格以上の場合

    * 「購入する」ボタンを活性化
  * 所持コインが不足している場合

    * コイン不足メッセージを表示
    * 「コインを購入する」ボタンを表示

* 購入処理（コイン消費）

  * 「購入する」タップ時に購入APIを実行
  * 正常終了時

    * コインを減算
    * 購入履歴を保存
    * 動画を視聴可能状態に更新
    * 動画詳細へ遷移
  * 失敗時

    * エラーメッセージを表示し、状態は変更しない

* コイン購入（Stripe）

  * 「コインを購入する」タップ時

    * Stripe Checkout 画面へ遷移
  * 決済完了後

    * コイン残高を加算
    * 本画面へ戻り、再判定を行う

  * 決済失敗時

    * 直前に表示していた画面（本画面）へ戻る
    * 残高は変わらないため、再判定しても購入不可のまま（不足表示を維持）

* キャンセル

  * 状態を変更せず動画詳細へ戻る

---

## Stripe 決済仕様（画面連携レベル）

* 決済方式: Stripe Checkout
* 決済対象: コインパック（例：100 / 300 / 500 コイン）
* 決済完了通知: Webhook によりサーバー側で反映
* フロント側は決済完了リダイレクト後に残高を再取得する

---

## 備考

* コイン価格・動画価格は管理側で変更可能な設計とする
* コイン消費・付与はすべてサーバー側で管理し、クライアント側では計算しない
* 将来的に以下拡張を想定

  * 割引価格
  * 期間限定無料
  * セット販売（複数動画まとめ購入）
