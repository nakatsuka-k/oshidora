# 通知設定画面 設計書

---

## 画面名

* 画面ID：APP-NOTIF-SET-001
* 画面名：通知設定
* 目的：アプリ通知（プッシュ通知・アプリ内通知）の受信可否をユーザーが設定できるようにする
* 遷移元：

  * マイページ（APP-MYP-001）＞ 設定（APP-SET-001）＞ 通知設定
* 遷移先：

  * 設定（APP-SET-001）（戻る）
  * OS通知設定画面（端末側設定への遷移）

---

## 画面概要

* 通知カテゴリごとに ON/OFF を切り替える設定画面
* 大切なお知らせ（障害・利用規約変更等）は **固定ON（OFF不可）**
* 作品のお知らせ（新作公開・ランキング更新など）はユーザーがOFF可能
* 端末の通知許可（OS側）がOFFの場合は、アプリ内トグルだけでは通知が届かないため、状態表示と「端末設定を開く」導線を用意する

---

## 画面キャプチャ / ワイヤー

* 画面一覧の「通知設定」を参照（添付画像）

---

## 操作概要

* 各カテゴリを個別にON/OFF
  * 大切なお知らせ：ON固定（OFF不可）
  * 作品のお知らせ：OFF可能（新作公開／ランキング更新）
* 端末側で通知許可がOFFの場合、画面上部で案内し「端末設定を開く」ボタンを表示
* 変更は即時保存（トグル操作で保存）

---

## 詳細テーブル

| 部品名称            | 部品の種類   | 型    | 桁数  | IN | OUT | 初期値     | 表示仕様                           | エラーNo       | DB情報備考                    | テーブル名                      | カラム名                   |
| :-------------- | :------ | :--- | :-- | :- | :-- | :------ | :----------------------------- | :---------- | :------------------------ | :------------------------- | :--------------------- |
| 画面タイトル          | 見出し     | 文字列  | 20  |    | ○   | `通知設定`  | 画面上部中央                         |             |                           |                            |                        |
| 戻るボタン           | アイコンボタン | -    | -   | ○  |     | -       | 左上、前画面へ                        |             |                           |                            |                        |
| OS通知状態バナー       | バナー     | 文字列  | 120 | ○  | ○   | 状態により変化 | `端末の通知がオフです。設定から許可してください。`     | E-NOTIF-001 | OS権限を参照                   |                            |                        |
| 端末設定を開く         | ボタン     | -    | -   | ○  |     | -       | OS通知がOFFの時に表示                  | E-NOTIF-002 | deep link / open settings |                            |                        |
| セクション見出し        | ラベル     | 文字列  | 12  |    | ○   | `通知の種類` | 仕切り線付き                         |             |                           |                            |                        |
| 通知（全体）          | トグル     | bool | 1   | ○  | ○   | ON      | 全体ON/OFF（任意）。OFFで下位トグル非活性      |             | サーバ保存                     | user_notification_settings | master_enabled         |
| 大切なお知らせ         | トグル     | bool | 1   | ○  | ○   | ON      | `大切なお知らせ（運営から）`。ON固定（OFF不可） |             | 原則ON（OFF不可）               | user_notification_settings | important_enabled      |
| 作品のお知らせ：新作公開    | トグル     | bool | 1   | ○  | ○   | ON      | `新作公開のお知らせ`。OFF可               |             |                           | user_notification_settings | new_release_enabled    |
| 作品のお知らせ：ランキング更新 | トグル     | bool | 1   | ○  | ○   | ON      | `ランキング更新のお知らせ`。OFF可            |             |                           | user_notification_settings | ranking_update_enabled |
| 作品のお知らせ：購入/視聴関連 | トグル     | bool | 1   | ○  | ○   | ON      | `購入/視聴に関するお知らせ`（購入完了、決済、視聴権など） |             |                           | user_notification_settings | purchase_enabled       |
| 作品のお知らせ：コメント/返信 | トグル     | bool | 1   | ○  | ○   | ON      | `コメント・返信のお知らせ`                 |             |                           | user_notification_settings | comment_enabled        |
| テスト通知送信         | ボタン     | -    | -   | ○  |     | -       | 開発/検証用。本番は非表示でもOK              |             |                           |                            |                        |
| 保存状態トースト        | トースト    | 文字列  | 40  |    | ○   | -       | `保存しました`                       |             |                           |                            |                        |

> 初期値：
>
> * 大切なお知らせ：基本ON
> * 新作公開・ランキング更新：OFF可能（ユーザー選択）
>   ※「基本ON／OFF可能」の方針を画面文言にも反映

---

## 挙動仕様

### 1) OS通知許可との関係

* OS通知が **許可されていない** 場合：

  * 画面上部にバナー表示
  * 「端末設定を開く」を表示
  * アプリ内トグルは操作できる（保存はする）が、実際のプッシュ配信は端末側許可がONになるまで届かない
* OS通知が **許可されている** 場合：

  * バナー非表示

### 2) トグル操作

* トグル変更は即時保存（操作ごとにAPI呼び出し）
* 通信中はトグル右側に小さなローディング表示（または一時的に無効化）
* 失敗時：

  * トースト `保存に失敗しました。通信状況を確認して再度お試しください。`
  * 値を元に戻す（または「再試行」導線）

### 3) 全体トグル（採用する場合）

* 「通知（全体）」をOFFにすると、配下カテゴリを非活性表示
* 再度ONにすると、配下は前回状態に戻す（全部ONに戻さない）

### 4) 大切なお知らせの扱い

* 運用方針：基本ON
* 実装方針：**B（ユーザーがOFFできない／固定ON）**
* 画面上はON固定表示（必要ならトグルは無効化して表示）

---

## API/保存仕様（例）

* GET `/api/me/notification-settings`
* PUT `/api/me/notification-settings`

  * payload例：

    * `master_enabled`
    * `important_enabled`
    * `new_release_enabled`
    * `ranking_update_enabled`
    * `purchase_enabled`
    * `comment_enabled`
* プッシュ通知配信側は、ユーザー設定＋OS許可状態を加味して送信（OS許可は端末側なので、サーバ側は端末トークン有無で判定）

---

## 備考

* 「大切なお知らせは基本ON」「作品のお知らせ（新作公開・ランキング更新など）はOFF可」を文言と初期値に反映
* 作品系の通知は将来的にカテゴリ追加が出やすいので、DB設計は拡張しやすい形（キー追加）にしておく
