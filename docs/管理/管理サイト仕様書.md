# 推しドラ 管理サイト（CMS）設計書（PH1中心／将来拡張PH2考慮）

## 0. 目的と前提

* 対象：**運営向け管理サイト（Web CMS）**
* PH1：**運営のみ**が利用（動画登録・編集・コメント承認・お知らせ配信・ユーザー参照など）
* 将来：**運営 / 事務所管理者 / 演者**の権限分離を想定 

### 0-1. 環境URL / API Base

* **API Base（本番）**：`https://api.oshidra.com`
  * 疎通確認：`GET /health` → `ok`
  * CMS API：`/cms/*`（例：`POST /cms/auth/login`）
* **管理サイト（Web）**：API Base はデフォルトで上記を利用
  * ローカル開発でもデフォルトは本番 API Base（`https://api.oshidra.com`）
  * ローカルAPI（wrangler dev）へ向けたい場合は、管理サイトの **API Base Override**（/dev）または `?api=http://localhost:8787` で上書きする

---

## 1. 権限ロール（PH1確定＋PH2想定）

### PH1（確定）

* **運営管理者（Admin）**：全機能利用可

### PH2（想定）

* **事務所管理者（AgencyAdmin）**：所属俳優・動画の管理（限定）
* **演者/登録者（Creator）**：動画登録・自分の投稿状況確認（限定）

> ※PH1では Admin のみで実装し、PH2でロール追加できる設計にする（DB/ACL準備だけ先行でもOK）

---

## 2. ナビゲーション（サイドメニュー想定：CMS_00052）

* ダッシュボード
* 動画管理

  * 配信予定
  * 動画一覧
  * 動画カテゴリ一覧
  * 動画タグ一覧
  * 動画アップロード
  * （将来）未承認動画
* コメント管理

  * 未承認/未対応
  * コメント一覧
* ユーザー管理

  * ユーザー一覧
* お知らせ管理
* ランキング
* マスタ管理

  * カテゴリ
  * タグ
  * コイン設定
* 管理者管理

---

## 3. 共通コンポーネント

* **CMS_00050 ヘッダー**：ログアウト、ユーザー表示 
* **CMS_00052 サイドメニュー**：上記メニュー 
* **CMS_00053 ダイアログ**：削除確認、公開切替確認など 
* **CMS_00054 エラー / CMS_00055 404 / CMS_00056 ポップアップ / CMS_00057 メンテ** 

---

# 4. 画面別 設計（画面ID単位）

## 4-1. 認証

### CMS_00001 ログイン 

**入力**

* メールアドレス
* パスワード

**操作**

* ログイン
* パスワード再設定（※要件があれば別途）

**結果**

* 成功：CMS_00002へ
* 失敗：エラーメッセージ（CMS_00054）

---

## 4-2. ダッシュボード

### CMS_00002 ホーム/ダッシュボード 

**表示ブロック（PH1）**

* 配信予定動画（次n件）
* （将来）動画承認待ち件数
* **未対応コメント件数（要件）**
* （必要なら）プロフィール承認待ち件数

**運用仕様**

* 「運営/登録者でアカウント切り分け」将来想定 

---

## 4-3. 動画：配信予定

### CMS_00003 配信予定動画一覧 

**一覧カラム**

* 配信予定日時
* タイトル
* 登録者（将来：承認者）

**操作**

* 詳細へ（CMS_00004）

### CMS_00004 動画詳細・編集（配信予定） 

**表示/編集**

* 配信予定日時（変更）
* 配信キャンセル

**権限（要検討→設計案）**

* PH1：Admin全員編集可
* PH2：登録者のみ編集可（または承認者のみ）

---

## 4-4. 動画：承認（将来機能だが画面は存在）

### CMS_00005 未承認動画一覧 

**一覧カラム**

* 承認依頼日
* タイトル
* 提出者名
* 配信希望日

**フェーズ**

* PH1：運営のみアップロード想定 → **承認機能不要** 
* PH2：運営＋事務所の二重チェック想定 

### CMS_00006 未承認動画詳細（承認/否認） 

**操作**

* 承認
* 否認（承認拒否）

**否認時の必須仕様（あなたの要件で明文化）**

* 否認理由コメント：必須
* 提出者へ通知：必須
* 提出者側で結果確認（ステータス/理由表示）：必須

---

## 4-5. コメント管理（ここはPH1必須）

### CMS_00007 未承認コメント一覧 

**一覧カラム**

* コメント記載日（承認依頼日）
* 対象動画タイトル
* 投稿者名

**操作**

* 詳細へ（CMS_00008）

### CMS_00008 コメント詳細（承認/否認） 

**表示**

* 対象（動画/演者）
* コメント本文
* 投稿者
* 投稿日時

**操作**

* 公開（承認）
* 非公開（否認/取り下げ）

**否認時の必須仕様（あなたの要件で明文化）**

* 投稿者へ通知（少なくともPH2／PH1でも推奨）

---

### CMS コメントの運用ステータス（要件確定）

> 「対応済み非公開」「未対応非公開」「公開済み」の3ステータスで管理。既読管理なし。新規コメントはメール通知。未対応件数をダッシュボード表示。

これをCMS設計として **以下の状態遷移に固定**します：

#### コメントステータス

* **未対応非公開**
* **対応済み非公開**
* **公開済み**

#### 遷移

* 未対応非公開 → 公開済み（承認）
* 未対応非公開 → 対応済み非公開（否認/削除/保留処理済）
* 公開済み → 対応済み非公開（後から非公開化）
* 対応済み非公開 → 公開済み（再公開する場合のみ）

#### 通知

* 新規コメント作成：**運営へメール通知**
* （任意）否認・公開：投稿者へ通知（アプリ側仕様に依存）

---

### CMS_00028 コメント一覧（対動画/対演者） 

**検索/ソート**

* コメント対象（動画/演者）
* 日時
* 投稿者
* 本文キーワード（任意）
* ステータス（上記3種）

### CMS_00029 コメント編集 

**操作**

* ステータス変更（公開⇄非公開）
* 削除（論理削除推奨：復元/監査のため）

---

## 4-6. 俳優アカウント承認（将来/運用次第）

### CMS_00009 未承認俳優アカウント一覧 

**対象**

* フリー俳優等の「個人登録」を想定する場合に必要 

### CMS_00010 俳優アカウント詳細（承認/非承認） 

**操作**

* 承認 / 非承認
* 非承認時：コメント送信（理由）

---

## 4-7. ランキング（閲覧中心）

* **CMS_00011** 動画ランキング 
* **CMS_00013** 保有コインランキング（管理者のみ） 
* **CMS_00015/17/19** 俳優/監督/脚本家ランキング（ロジック要検討） 

> ※ランキング更新は「日次更新」要件があるため、バッチ（cron/queue）前提で設計

---

## 4-8. お知らせ管理（プッシュ/メール）

### CMS_00021 お知らせ一覧 

**一覧カラム**

* 配信日時
* 件名
* 本文（要約）
* 登録者
* タグ（運営/イベントなど）

### CMS_00022 お知らせ詳細・編集 

**編集**

* 配信日時
* 件名
* 本文
* タグ
* プッシュ通知送信フラグ

### CMS_00023 お知らせ新規登録 

**機能（要件反映）**

* 即時 / 予約配信（手動設定）
* メール：プレーンテキスト（内容によりHTML切替）
* プッシュ通知タップ時：アプリ起動 or LP遷移（LPテンプレ：トップ画像＋テキスト）

---

## 4-9. 動画管理（メイン）

### CMS_00024 動画一覧 

**検索/ソート**

* アカウント
* 俳優
* 監督
* タイトル
* 公開/非公開
* （任意）シェア数（取得可否は技術確認） 

### CMS_00025 動画詳細・編集 

**機能**

* プレビュー
* 説明文編集
* シリーズ（同エピソード）紐付け
* 評価数閲覧
* 公開/非公開制御
* **字幕あり/なし MP4を2種登録**
* 再公開時に再承認が必要か：要検討 

### CMS_00030 動画アップロード（動画新規登録） 

**入力（案）**

* タイトル
* 説明
* サムネ画像（キャプチャ生成はしない）
* カテゴリ/タグ
* 出演者紐付け（キャスト/スタッフ）
* MP4（字幕あり）
* MP4（字幕なし）
* 公開設定（下書き/公開/配信予約）
* 作品タイプ（ショート/映画）・尺情報（参考）

---

## 4-10. おすすめ/ピックアップ枠

* **CMS_00026/27** おすすめ動画（対象動画に関連付け） 
* **CMS_00037/38** ピックアップ動画（枠表示設定） 

**検索条件**

* 動画名
* 出演者
* カテゴリ
* タグ

---

## 4-11. カテゴリ・タグ

* **CMS_00031〜33** 動画カテゴリ 
* **CMS_00034〜36** タグ 

---

## 4-12. コイン設定

* **CMS_00039〜41** コイン設定 
  **項目**
* 価格
* 表示場所
* 表示対象
* 表示期間

---

## 4-13. ユーザー管理

* **CMS_00042** ユーザー一覧（区分ソート） 
* **CMS_00043** ユーザー詳細（プロフィール/履歴/お気に入り等） 
* **CMS_00044** キャストプロフィール（同等情報） 
* **CMS_00045** ユーザー新規登録（運用次第） 

### 追加要件：プロフィール承認

あなたの要件「プロフィール編集後、反映前に運営承認が必要」を **CMS仕様として確定**する。

**プロフィールステータス（CMS側で持つ）**

* 反映済み
* 承認待ち
* 差し戻し（理由あり）

**操作**

* 承認（反映）
* 差し戻し（理由入力）
* 履歴参照（誰がいつ承認/差し戻ししたか）

> ※PDFでは「運営が個人アカウント編集可能か要検討」とあるため 、
> “編集”ではなく“承認フロー”として実装するのが整合が良い。

---

## 4-14. 管理者/事務所管理者

* **CMS_00046** 管理者一覧 
* **CMS_00047** 運営管理者詳細（削除/更新） 
* **CMS_00049** 管理者新規登録 
* **CMS_00048** 事務所管理者詳細（将来） 

---

# 5. ステータス表（CMS側：確定版）

## 5-1. コメントステータス（要件確定）

| ステータス   | CMS表示 | アプリ表示 | 説明                         |
| ------- | ----: | ----: | -------------------------- |
| 未対応非公開  |     ○ |     × | 新規。未審査。                    |
| 公開済み    |     ○ |     ○ | 承認済み。公開中。                  |
| 対応済み非公開 |     ○ |     × | 対応完了だが非公開（否認/削除/取り下げ含む運用）。 |

**ルール**

* 既読管理：しない
* 新規コメント：運営へメール通知
* ダッシュボード：未対応件数表示

---

## 5-2. プロフィール承認ステータス（CMS側で追加）

| ステータス | 説明           | 必須項目    |
| ----- | ------------ | ------- |
| 反映済み  | 現在公開中のプロフィール | なし      |
| 承認待ち  | ユーザー編集後、未反映  | 申請データ一式 |
| 差し戻し  | NG。修正依頼      | 差し戻し理由  |

---

## 5-3. 動画公開ステータス（PH1最低限）

| ステータス   | CMS表示 |    アプリ表示 | 説明         |
| ------- | ----: | -------: | ---------- |
| 下書き/非公開 |     ○ |        × | 登録済みだが視聴不可 |
| 公開      |     ○ |        ○ | 視聴可        |
| 配信予約    |     ○ | （日時到来後）○ | 指定日時に公開    |

※PH2で「承認待ち/否認」を追加（CMS_00005/06運用開始） 

---

## 5-4. お知らせ配信ステータス（運用推奨）

| ステータス | 説明      |
| ----- | ------- |
| 下書き   | 作成中     |
| 予約    | 指定日時で送信 |
| 送信済み  | 送信完了    |
| 取消    | 予約取消    |

---

# 6. 通知仕様（CMS起点）

## 6-1. メール通知

* 新規コメント投稿発生時：運営へメール（必須要件）
* （任意）コメント否認時：投稿者へ通知
* （任意）プロフィール差し戻し：ユーザーへ通知

## 6-2. プッシュ通知（お知らせ）

* 送信タイミング：即時 / 予約（手動）
* 遷移：アプリ起動 or LP（テンプレ）

---

# 7. データ紐付け（CMS側で管理する対象）

* 動画 ↔ キャスト/スタッフ（プロフィール）紐付け（出演情報）
* 動画 ↔ シリーズ（エピソード）紐付け
* 動画 ↔ おすすめ/ピックアップ枠
* 動画 ↔ カテゴリ/タグ

---

# 8. 未決事項（設計で空欄にせず、決め打ち推奨）

1. **コメント否認時：投稿者通知をPH1で必須にするか**
2. **動画の再公開時：再承認が必要か** 
3. **削除の扱い：論理削除で統一するか**（監査/復元の要否）
