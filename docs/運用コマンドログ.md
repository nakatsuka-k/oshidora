# 運用コマンドログ（oshidora）

更新日: 2026-01-05

このファイルは「Cloudflare（D1/Workers/Pages）構築・デプロイ」と「ローカル開発」で実行したコマンドを時系列で残します。

IP制限（Pages allowlist）: [docs/IP許可リスト.md](docs/IP%E8%A8%B1%E5%8F%AF%E3%83%AA%E3%82%B9%E3%83%88.md)

---

## 2026-01-05（実行済み）

### Mobile / Web build

- `npx expo install react-native-svg`
- `npx tsc -p apps/mobile/tsconfig.json --noEmit`
- `npm run build:web`（= `npm -w apps/mobile run export:web`）

### Cloudflare（Wrangler）

- ※ `npx wrangler` だと別バージョンが混ざるケースがあったため、以降は `apps/api` のローカル `wrangler`（4.54.0）を明示して実行

- `cd apps/api && npx wrangler whoami`

### R2（プロフィール画像アップロード / S3 API）

※ Web から R2 の S3 API へ直接 PUT すると CORS で失敗するため、API 経由でアップロードする実装。

**ローカル開発:**

1. `.dev.vars.example` をコピーしてローカル`.dev.vars`を作成
   - `cp apps/api/.dev.vars.example apps/api/.dev.vars`
2. `.dev.vars` に R2 S3 API credential を入力（Cloudflare R2 > S3 API Credentials）
   - `R2_ACCESS_KEY_ID=3ab864179e0622e82d1af69b71a6027f`
   - `R2_SECRET_ACCESS_KEY=9488b62b738e153c8f9b6a888257c7c3d9b789436678efc698dd2916750f430e`

**本番環境（2026-01-09 実施済み）:**

- `wrangler.toml` に `[env.production]` セクション追加
- 秘密情報をワーカーシークレットとして登録済み：
  - `R2_ACCESS_KEY_ID=3ab864179e0622e82d1af69b71a6027f` ✅
  - `R2_SECRET_ACCESS_KEY=9488b62b738e153c8f9b6a888257c7c3d9b789436678efc698dd2916750f430e` ✅
- デプロイ済み:
  - `npx wrangler deploy --env production`
  - 本番URL: https://oshidora-api-production.tecpge.workers.dev ✅

非secret設定（公開情報、`wrangler.toml` にコミット）:

- `R2_BUCKET = "assets"`
- `R2_PUBLIC_BASE_URL = "https://pub-a2d549876dd24a08aebc65d95ed4ff91.r2.dev"`

### Cloudflare（D1 / Workers / Pages）

対象アカウント:

- `CLOUDFLARE_ACCOUNT_ID=c6270d2ac0aefb2ca6ce6831cbc9ca30`

Wrangler バージョン確認:

- `./apps/api/node_modules/.bin/wrangler --version`

D1（本番）:

- `./apps/api/node_modules/.bin/wrangler d1 list`
- `./apps/api/node_modules/.bin/wrangler d1 create oshidora-db`
- D1 UUID: `1f7de46f-7b0c-4150-ae76-6dd762a23f71`
- `apps/api/wrangler.toml` の `database_id` を作成結果の UUID に更新
- `npm run db:migrate:remote`

Workers（API）:

- `npm run deploy:api`
- API URL: `https://oshidora-api.kousuke-c62.workers.dev`

Pages（Web）:

- `npm run build:web`
- `CLOUDFLARE_ACCOUNT_ID=c6270d2ac0aefb2ca6ce6831cbc9ca30 ./apps/api/node_modules/.bin/wrangler pages project create oshidora-web --production-branch main`
- `CLOUDFLARE_ACCOUNT_ID=c6270d2ac0aefb2ca6ce6831cbc9ca30 ./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web`
- Pages deployment: `462af6ae`（Production / main）
- Pages URL: `https://462af6ae.oshidora-web.pages.dev`

IP制限（_worker.js）反映後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true`
- Pages deployment: `af3970cc`（Production / main）
- Pages URL: `https://af3970cc.oshidora-web.pages.dev`

commit message/hash を付けたデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "IP allowlist + GH Actions" --commit-hash "manual-<timestamp>"`
- Pages deployment: `b33f1999`（Production / main）
- Pages URL: `https://b33f1999.oshidora-web.pages.dev`

Web（URL hash routing）反映後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Web URL hash routing"`
- Pages deployment: `1baa2280`（Production / main）
- Pages URL: `https://1baa2280.oshidora-web.pages.dev`

チュートリアル画像/ロゴ/サムネ反映後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Use tutorial images + logo + thumbnails"`
- Pages deployment: `2f0c259c`（Production / main）
- Pages URL: `https://2f0c259c.oshidora-web.pages.dev`

チュートリアル画像/サムネ反映（調整）後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Tutorial images + thumbnails"`
- Pages deployment: `e2bb8dd8`（Production / main）
- Pages URL: `https://e2bb8dd8.oshidora-web.pages.dev`

利用規約本文 + Developerメニュー反映後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Terms + developer menu"`
- Pages deployment: `52dc838f`（Production / main）
- Pages URL: `https://52dc838f.oshidora-web.pages.dev`

新規登録パスワードの目アイコン + Webタイトル反映後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Password eye toggle + web title"`
- Pages deployment: `594ad559`（Production / main）
- Pages URL: `https://594ad559.oshidora-web.pages.dev`

チュートリアルUX修正（画像拡大/ページネーション改善/戻る追加）後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Tutorial UX fixes"`
- Pages deployment: `df27ad22`（Production / main）
- Pages URL: `https://df27ad22.oshidora-web.pages.dev`

新規登録の目アイコン（SVG）+ 表示切替修正後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Fix password eye toggle"`
- Pages deployment: `5401c535`（Production / main）
- Pages URL: `https://5401c535.oshidora-web.pages.dev`

フッター固定（規約同意ボタン/タブバー全幅）反映後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Fixed footers"`
- Pages deployment: `077e7859`（Production / main）
- Pages URL: `https://077e7859.oshidora-web.pages.dev`

規約画面：同意して新規登録のみ＋下余白調整のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Terms footer padding"`
- Pages deployment: `f5fbb4ba`（Production / main）
- Pages URL: `https://f5fbb4ba.oshidora-web.pages.dev`

Welcome導線再構成（タップ→ログイン/会員登録）＋PC最大幅適用のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Welcome flow + max width"`
- Pages deployment: `98b275f8`（Production / main）
- Pages URL: `https://98b275f8.oshidora-web.pages.dev`

Debugページにページネーション/スライドショー（共通コンポーネント）追加のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Debug: pagination + slideshow"`
- Pages deployment: `f0779236`（Production / main）
- Pages URL: `https://f0779236.oshidora-web.pages.dev`

Welcome（Netflix風）＋ログイン画面にロゴ追加のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Welcome Netflix style + login logo"`
- Pages deployment: `c38246d5`（Production / main）
- Pages URL: `https://c38246d5.oshidora-web.pages.dev`

IP制限 allowlist に `160.249.29.251` を追加したデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Add allowlist IP 160.249.29.251"`
- Pages deployment: `52580597`（Production / main）
- Pages URL: `https://52580597.oshidora-web.pages.dev`

---

## 2026-01-09（認証：Email + SMS）

### D1（スキーマ追加）

- 追加マイグレーション: `apps/api/migrations/0003_auth.sql`
- 実行（本番）:
  - `npm run db:migrate:remote`

### Workers Secrets（本番/ステージング）

※ **Twilio の Auth Token など秘密情報は絶対にリポジトリへコミットしない**（チャット/ログにも貼らない運用推奨）。

- JWT署名・コードハッシュ用:
  - `cd apps/api && npx wrangler secret put AUTH_JWT_SECRET --env production`
  - `cd apps/api && npx wrangler secret put AUTH_CODE_PEPPER --env production`

補足（`It looks like you've run a Workers-specific command in a Pages project.` が出る場合）:

- **ルートディレクトリで実行している**可能性があります。必ず `cd apps/api` してから実行してください。
- もしくは `--config apps/api/wrangler.toml` を付けて Workers 設定を明示します:
  - `npx wrangler secret put MAIL_FROM --env production --config apps/api/wrangler.toml`

- SMS（Twilio）:
  - `cd apps/api && npx wrangler secret put TWILIO_ACCOUNT_SID --env production`
  - `cd apps/api && npx wrangler secret put TWILIO_AUTH_TOKEN --env production`
  - `cd apps/api && npx wrangler secret put TWILIO_FROM --env production`

- Email（MailChannels）:
  - `MAIL_FROM=info@oshidra.com`（Cloudflare Email Routingで作成した送信元）
  - `MAIL_FROM` は non-secret なので `wrangler.toml` の `[env.production.vars]` に入れても良い
  - もしくは secret として運用する場合:
    - `cd apps/api && npx wrangler secret put MAIL_FROM --env production`

### デバッグ用（任意）

- APIが `debugCode` を返す（開発用途のみ）:
  - `ALLOW_DEBUG_RETURN_CODES=1`
  - ※ 本番で有効化しないこと

---

## これから実行（手順）

### 1) D1（本番）

- `cd apps/api && npx wrangler d1 create oshidora-db`
- `apps/api/wrangler.toml` の `database_id` を上書き
- `npm run db:migrate:remote`

### 2) Workers（API）

- `npm run deploy:api`

### 3) Pages（Web）

- `npm run build:web`
- `npx wrangler pages project create <project>`（未作成の場合）
- `npx wrangler pages deploy apps/mobile/dist --project-name <project>`

補足（IP制限）:

- `npm run build:web` の中で `apps/mobile/dist/_worker.js` を生成し、許可IP以外を 403 にします
- 許可IPは環境変数 `OSHIDORA_ALLOWED_IPS`（カンマ区切り）で上書き可能

### 4) IP制限（oshidora.com）

- 前提: `oshidora.com` が Cloudflare 管理（DNS が Cloudflare）になっていること
- Pages 側で `oshidora.com` を Custom Domain に追加（※現状 Wrangler だけでは完結しないので Cloudflare Dashboard で作業）
- allowlist したい IP 一覧が確定したら、Cloudflare WAF（Custom Rules）または Cloudflare Zero Trust（Access）で制限

### 4-1) `oshidora.com` を Pages に紐付け（Dashboard）

1. Cloudflare Dashboard → Pages → `oshidora-web` → **Custom domains**
2. `oshidora.com` を追加（必要なら `www.oshidora.com` も）
3. 指示に従って DNS レコードを作成（すでに Cloudflare DNS 管理なら自動作成されることがあります）
4. SSL/TLS が Active になるまで待機

確認:

- `https://oshidora.com` にアクセスして表示されること

### 4-2) IP制限の適用範囲

このリポジトリでは `apps/mobile/dist/_worker.js` により Pages 側で IP 制限を行います。

- 許可IP以外は常に 403
- `oshidora.com` を Pages に紐付ければ、`oshidora.com` 経由のアクセスにも同じ制限が適用されます

WAF（Custom Rule）の例（イメージ）:

- 条件: `not ip.src in { <許可IP1> <許可IP2> ... }`
- アクション: Block

※ Pages 側の `_worker.js` で制限するため、WAF ルールは必須ではありません（追加で二重化したい場合のみ）

---

## GitHub Actions（自動デプロイ）

ワークフロー: `.github/workflows/deploy-pages.yml`

必要な GitHub Secrets:

- `CLOUDFLARE_API_TOKEN`（Pages:Edit 相当の権限を持つトークン）
- `CLOUDFLARE_ACCOUNT_ID`（このリポジトリがデプロイする Cloudflare アカウントID）
