# 運用コマンドログ（oshidora）

更新日: 2026-01-05

このファイルは「Cloudflare（D1/Workers/Pages）構築・デプロイ」と「ローカル開発」で実行したコマンドを時系列で残します。

---

## 2026-01-05（実行済み）

### Mobile / Web build

- `npx expo install react-native-svg`
- `npx tsc -p apps/mobile/tsconfig.json --noEmit`
- `npm run build:web`（= `npm -w apps/mobile run export:web`）

### Cloudflare（Wrangler）

- ※ `npx wrangler` だと別バージョンが混ざるケースがあったため、以降は `apps/api` のローカル `wrangler`（4.54.0）を明示して実行

- `cd apps/api && npx wrangler whoami`

### Cloudflare（D1 / Workers / Pages）

対象アカウント:

- `CLOUDFLARE_ACCOUNT_ID=c6270d2ac0aefb2ca6ce6831cbc9ca30`

Wrangler バージョン確認:

- `./apps/api/node_modules/.bin/wrangler --version`

D1（本番）:

- `./apps/api/node_modules/.bin/wrangler d1 list`
- `./apps/api/node_modules/.bin/wrangler d1 create oshidora-db`
- D1 UUID: `1f7de46f-7b0c-4150-ae76-6dd762a23f71`
- `apps/api/wrangler.toml` の `database_id` を作成結果の UUID に更新
- `npm run db:migrate:remote`

Workers（API）:

- `npm run deploy:api`
- API URL: `https://oshidora-api.kousuke-c62.workers.dev`

Pages（Web）:

- `npm run build:web`
- `CLOUDFLARE_ACCOUNT_ID=c6270d2ac0aefb2ca6ce6831cbc9ca30 ./apps/api/node_modules/.bin/wrangler pages project create oshidora-web --production-branch main`
- `CLOUDFLARE_ACCOUNT_ID=c6270d2ac0aefb2ca6ce6831cbc9ca30 ./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web`
- Pages deployment: `462af6ae`（Production / main）
- Pages URL: `https://462af6ae.oshidora-web.pages.dev`

IP制限（_worker.js）反映後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true`
- Pages deployment: `af3970cc`（Production / main）
- Pages URL: `https://af3970cc.oshidora-web.pages.dev`

commit message/hash を付けたデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "IP allowlist + GH Actions" --commit-hash "manual-<timestamp>"`
- Pages deployment: `b33f1999`（Production / main）
- Pages URL: `https://b33f1999.oshidora-web.pages.dev`

Web（URL hash routing）反映後のデプロイ:

- `./apps/api/node_modules/.bin/wrangler pages deploy apps/mobile/dist --project-name oshidora-web --branch main --commit-dirty=true --commit-message "Web URL hash routing"`
- Pages deployment: `1baa2280`（Production / main）
- Pages URL: `https://1baa2280.oshidora-web.pages.dev`

---

## これから実行（手順）

### 1) D1（本番）

- `cd apps/api && npx wrangler d1 create oshidora-db`
- `apps/api/wrangler.toml` の `database_id` を上書き
- `npm run db:migrate:remote`

### 2) Workers（API）

- `npm run deploy:api`

### 3) Pages（Web）

- `npm run build:web`
- `npx wrangler pages project create <project>`（未作成の場合）
- `npx wrangler pages deploy apps/mobile/dist --project-name <project>`

補足（IP制限）:

- `npm run build:web` の中で `apps/mobile/dist/_worker.js` を生成し、許可IP以外を 403 にします
- 許可IPは環境変数 `OSHIDORA_ALLOWED_IPS`（カンマ区切り）で上書き可能

### 4) IP制限（oshidora.com）

- 前提: `oshidora.com` が Cloudflare 管理（DNS が Cloudflare）になっていること
- Pages 側で `oshidora.com` を Custom Domain に追加（※現状 Wrangler だけでは完結しないので Cloudflare Dashboard で作業）
- allowlist したい IP 一覧が確定したら、Cloudflare WAF（Custom Rules）または Cloudflare Zero Trust（Access）で制限

### 4-1) `oshidora.com` を Pages に紐付け（Dashboard）

1. Cloudflare Dashboard → Pages → `oshidora-web` → **Custom domains**
2. `oshidora.com` を追加（必要なら `www.oshidora.com` も）
3. 指示に従って DNS レコードを作成（すでに Cloudflare DNS 管理なら自動作成されることがあります）
4. SSL/TLS が Active になるまで待機

確認:

- `https://oshidora.com` にアクセスして表示されること

### 4-2) IP制限の適用範囲

このリポジトリでは `apps/mobile/dist/_worker.js` により Pages 側で IP 制限を行います。

- 許可IP以外は常に 403
- `oshidora.com` を Pages に紐付ければ、`oshidora.com` 経由のアクセスにも同じ制限が適用されます

WAF（Custom Rule）の例（イメージ）:

- 条件: `not ip.src in { <許可IP1> <許可IP2> ... }`
- アクション: Block

※ Pages 側の `_worker.js` で制限するため、WAF ルールは必須ではありません（追加で二重化したい場合のみ）

---

## GitHub Actions（自動デプロイ）

ワークフロー: `.github/workflows/deploy-pages.yml`

必要な GitHub Secrets:

- `CLOUDFLARE_API_TOKEN`（Pages:Edit 相当の権限を持つトークン）
- `CLOUDFLARE_ACCOUNT_ID`（このリポジトリがデプロイする Cloudflare アカウントID）
