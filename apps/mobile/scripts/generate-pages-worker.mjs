import fs from 'node:fs';
import path from 'node:path';

const repoRoot = process.cwd();

const distDir = path.join(repoRoot, 'dist');
const outFile = path.join(distDir, '_worker.js');

const ALLOWED_IPS = [
  '223.135.200.51',
  '117.102.205.215',
  '133.232.96.225',
  '3.114.72.126',
  '133.200.10.97',
  '159.28.175.137',
]

function main() {
  if (!fs.existsSync(distDir)) {
    console.error(`[generate-pages-worker] dist directory not found: ${distDir}`);
    process.exit(1);
  }

  const ipsJson = JSON.stringify(ALLOWED_IPS);
  
  const source = `// Auto-generated by apps/mobile/scripts/generate-pages-worker.mjs
// Pages Worker with IP allowlist protection

const ALLOWED_IPS = ${ipsJson};

function splitXForwardedFor(xff) {
  if (!xff) return [];
  return String(xff)
    .split(',')
    .map((s) => s.trim())
    .filter(Boolean);
}

function getClientIps(request) {
  const cf = request.headers.get('CF-Connecting-IP') || '';
  const xff = request.headers.get('X-Forwarded-For') || '';
  const ips = [];
  if (cf) ips.push(cf);
  ips.push(...splitXForwardedFor(xff));
  // uniq
  return {
    cf,
    xff,
    ips: Array.from(new Set(ips)).filter(Boolean),
  };
}

function isIPAllowed(ips) {
  return ips.some((clientIP) => ALLOWED_IPS.some((allowed) => clientIP === allowed));
}

function getDeniedHTML(details) {
  return '<!DOCTYPE html>' +
    '<html>' +
    '<head>' +
    '  <meta charset="UTF-8">' +
    '  <meta name="viewport" content="width=device-width, initial-scale=1.0">' +
    '  <title>Access Denied</title>' +
    '  <style>' +
    '    body {' +
    '      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;' +
    '      display: flex;' +
    '      justify-content: center;' +
    '      align-items: center;' +
    '      height: 100vh;' +
    '      margin: 0;' +
    '      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' +
    '    }' +
    '    .container {' +
    '      text-align: center;' +
    '      background: white;' +
    '      padding: 40px;' +
    '      border-radius: 8px;' +
    '      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);' +
    '      max-width: 500px;' +
    '    }' +
    '    h1 {' +
    '      color: #d32f2f;' +
    '      margin: 0 0 16px 0;' +
    '      font-size: 28px;' +
    '    }' +
    '    p {' +
    '      color: #666;' +
    '      margin: 0;' +
    '      line-height: 1.6;' +
    '      font-size: 16px;' +
    '    }' +
    '    .error-code {' +
    '      color: #999;' +
    '      margin-top: 20px;' +
    '      font-size: 12px;' +
    '      font-family: monospace;' +
    '      background: #f5f5f5;' +
    '      padding: 10px;' +
    '      border-radius: 4px;' +
    '    }' +
    '  </style>' +
    '</head>' +
    '<body>' +
    '  <div class="container">' +
    '    <h1>â›” Access Denied</h1>' +
    '    <p>Your IP address is not authorized to access this resource.</p>' +
    '    <div class="error-code">' +
    '      CF-Connecting-IP: ' + (details.cf || '(none)') + '<br>' +
    '      X-Forwarded-For: ' + (details.xff || '(none)') + '<br>' +
    '      Parsed IPs: ' + (details.ips && details.ips.length ? details.ips.join(', ') : '(none)') +
    '    </div>' +
    '    <p style="margin-top:12px; font-size: 13px; color:#999;">Whitelist the public IP shown above (CF-Connecting-IP).</p>' +
    '  </div>' +
    '</body>' +
    '</html>';
}

export default {
  async fetch(request, env) {
    const details = getClientIps(request);
    
    if (!isIPAllowed(details.ips)) {
      return new Response(getDeniedHTML(details), {
        status: 403,
        headers: { 'Content-Type': 'text/html; charset=utf-8' },
      });
    }

    return env.ASSETS.fetch(request);
  },
};
`;

  fs.writeFileSync(outFile, source, 'utf8');
  console.log(`[generate-pages-worker] wrote ${path.relative(repoRoot, outFile)}`);
  console.log('[generate-pages-worker] IP allowlist enabled for oshidra.com');
}

main();
