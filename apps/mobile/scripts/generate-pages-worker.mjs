import fs from 'node:fs';
import path from 'node:path';

const repoRoot = process.cwd();

const distDir = path.join(repoRoot, 'dist');
const outFile = path.join(distDir, '_worker.js');

// NOTE:
// Cloudflare Pages の IP allowlist 制限は廃止しました。
// このスクリプトは build の一部として dist/_worker.js を生成しますが、
// 現在は「素通し（静的アセット配信のみ）」の Worker を出力します。

function main() {
  if (!fs.existsSync(distDir)) {
    console.error(`[generate-pages-worker] dist directory not found: ${distDir}`);
    process.exit(1);
  }

  const source = `// Auto-generated by apps/mobile/scripts/generate-pages-worker.mjs\n// Pass-through Pages Worker (no IP restriction).\n\nexport default {\n  async fetch(request, env) {\n    // In Pages, env.ASSETS.fetch serves static assets\n    return env.ASSETS.fetch(request);\n  },\n};\n`;

  fs.writeFileSync(outFile, source, 'utf8');
  console.log(`[generate-pages-worker] wrote ${path.relative(repoRoot, outFile)}`);
  console.log('[generate-pages-worker] IP allowlist disabled (pass-through worker)');
}

main();
