import fs from 'node:fs';
import path from 'node:path';

const repoRoot = process.cwd();

const distDir = path.join(repoRoot, 'dist');
const outFile = path.join(distDir, '_worker.js');

const defaultAllowedIps = [
  '159.28.175.137',
  '223.135.200.51',
  '117.102.205.215',
  '133.232.96.225',
];

function parseAllowedIps(value) {
  if (!value) return defaultAllowedIps;
  return value
    .split(',')
    .map((s) => s.trim())
    .filter(Boolean);
}

function escapeJsString(s) {
  return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}

function main() {
  if (!fs.existsSync(distDir)) {
    console.error(`[generate-pages-worker] dist directory not found: ${distDir}`);
    process.exit(1);
  }

  const allowedIps = parseAllowedIps(process.env.OSHIDORA_ALLOWED_IPS);

  const source = `// Auto-generated by apps/mobile/scripts/generate-pages-worker.mjs\n// Blocks all requests except allowlisted IPs.\n\nconst ALLOWED_IPS = new Set([${allowedIps
    .map((ip) => `'${escapeJsString(ip)}'`)
    .join(', ')}]);\n\nfunction getClientIp(request) {\n  // Cloudflare populates cf-connecting-ip for client IP\n  return request.headers.get('cf-connecting-ip') || '';\n}\n\nfunction forbidden() {\n  return new Response('Forbidden', { status: 403, headers: { 'content-type': 'text/plain; charset=utf-8' } });\n}\n\nexport default {\n  async fetch(request, env, ctx) {\n    const ip = getClientIp(request);\n    if (!ALLOWED_IPS.has(ip)) return forbidden();\n\n    // In Pages, env.ASSETS.fetch serves static assets\n    return env.ASSETS.fetch(request);\n  },\n};\n`;

  fs.writeFileSync(outFile, source, 'utf8');
  console.log(`[generate-pages-worker] wrote ${path.relative(repoRoot, outFile)}`);
  console.log(`[generate-pages-worker] allowed IPs: ${allowedIps.join(', ')}`);
}

main();
